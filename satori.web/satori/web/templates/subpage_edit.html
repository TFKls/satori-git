{% extends "templates/index.html" %}

{% block content %}

{% if page_info.contest %}
<form action={% url contest_subpage_edit page_info.contest.id subpage.id %} method="POST" id="edit_form">
{% else %}
<form action={% url subpage_edit message.id %} method="POST" id="edit_form">
{% endif %}

<input name="fid" value="{{ fid }}" type="hidden">
<table>
{{ form.as_table }}
</table>
<input type="submit" value="Save"/>
</form>

<form id="file_upload" action={% url contest_subpage_fileupload page_info.contest.id %} method="POST" enctype="multipart/form-data" class="file_upload">
    <input type="file" name="file" multiple>
    <input name="fid" value="{{ fid }}" type="hidden">
    <button>Upload</button>
    <div>Attachments</div>
</form>
<table id="files">
    {% for dfile in attachments %}
    <tr> 
        <td>{{ dfile }}</td>
        <td>
        <form class="remove_existing">
            <input name="rfile" value="{{ dfile }}" type="hidden">
            <button type="submit">Cancel</button>
        </form>
        </td>
    </tr>
    {% endfor %}
</table>
<script>
var actualFilesList = {};
$(function() {
    $('#files input[name="rfile"]').each(function() {
        actualFilesList[$(this).val()] = true;
    });
});
$(function() {
    var removedFilesCounter = 0;
    $('.remove_existing').submit(function(event) {
        event.preventDefault();
        var form = $(event.target); rfile = form.find('input').val();

        $('#edit_form').append(
            '<input type="hidden" name="rfile_' + removedFilesCounter + 
            '" value="' + rfile + '">'
        );

        delete actualFilesList[rfile];
        removedFilesCounter = removedFilesCounter + 1;
        $(event.target).parent().parent().remove();
        return false;
    });
});

$(function () {
    var notCompletedCounter = 0;
    var $wrongFileDialog = $('<div></div>')
            .html('File with a given name already exists!')
            .dialog({
                autoOpen: false,
                resizable: false,
                title: 'Wrong file name'
            });
    $wrongFileDialog.css('font-size: 62.5%');
    $('#file_upload').fileUploadUI({
        uploadTable: $('#files'),
        downloadTable: $('#files'),
        beforeSend: function (event, files, index, xhr, handler, callBack) {
            ex = 0;
            if (actualFilesList[files[index].name]) {
                handler.removeNode(handler.uploadRow);
                $wrongFileDialog.dialog("open");
                return;
            }
            if (files[index].size > 10000000) {
                handler.uploadRow.find('.file_upload_progress').html(' FILE TOO BIG!');
                setTimeout(function () {
                    handler.removeNode(handler.uploadRow);
                }, 5000);
                return;
            }
            actualFilesList[files[index].name] = true;
            $("#create_subpage").attr("disabled", true);
            notCompletedCounter = notCompletedCounter + files.length;
            callBack();
        },
        buildUploadRow: function (files, index) {
            return $('<tr><td>' + files[index].name + '<\/td>' +
                    '<td class="file_upload_progress"><div><\/div><\/td>' +
                    '<td class="file_upload_cancel">' +
                    '<button class="ui-state-default ui-corner-all" title="Cancel">' +
                    '<span class="ui-icon ui-icon-cancel">Cancel<\/span>' +
                    '<\/button><\/td><\/tr>');
        },
        buildDownloadRow: function (file) {
            return $('<tr><td>' + file.name + '<\/td>' + 
                    '<td><form><button type="submit">Cancel<\/button><\/form><\/td><\/tr>');
        },
        onAbort: function (event, files, index, xhr, handler) {
            handler.removeNode(handler.uploadRow);
            delete actualFilesList[files[index].name];
        },
        onComplete: function (event, files, index, xhr, handler) {
            notCompletedCounter = notCompletedCounter - files.length;
            if (notCompletedCounter == 0) {
                $("#create_subpage").attr("disabled", false);
            }
            handler.downloadRow.find('form').submit(function(event) {
                event.preventDefault();
/*                $('#loading').fadeIn();*/
                $.ajax({
                    data: {
                        fid : '{{ fid }}',
                        filename : files[index].fileName
                    },
                    url: '{% url contest_subpage_fileremove page_info.contest.id %}',
                    type: 'POST',
                    success: function (data) {
                        /*$('#loading').fadeOut();*/
                        handler.downloadRow.remove();
                    }
                });
                return false;
            });
        }
    });
});
</script>
{% endblock %}
